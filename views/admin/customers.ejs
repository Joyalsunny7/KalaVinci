<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Admin | Customers</title>
    <link rel="stylesheet" href="/css/admin/customer.css" />
</head>

<body>
    <div id="toast-container"></div>


    <%- include('../partials/admin/sidebar') %>
        <main class="admin-content">

            <h1>Users</h1>

            <form method="GET" class="table-controls">

                <div class="search-box">
                    <input type="text" name="search" placeholder="Search users..." value="<%= search %>" />
                    <% if (search) { %>
                        <a href="/admin/customers" class="clear-btn">âœ•</a>
                        <% } %>
                </div>

                <div class="filter-box">
                    <select name="sort" onchange="this.form.submit()">
                        <option value="desc" <%=sort==='desc' ? 'selected' : '' %>>
                            Newest First
                        </option>
                        <option value="asc" <%=sort==='asc' ? 'selected' : '' %>>
                            Oldest First
                        </option>
                    </select>
                </div>

            </form>


            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Joined</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>

                <tbody>
                    <% customers.forEach(user=> { %>
                        <tr>
                            <td>
                                <%= user.full_name %>
                            </td>
                            <td>
                                <%= user.email %>
                            </td>
                            <td>
                                <%= user.phone || "-" %>
                            </td>
                            <td>
                                <%= user.createdAt.toDateString() %>
                            </td>

                            <td>
                                <span class="status <%= user.isBlocked ? 'blocked' : 'active' %>">
                                    <%= user.isBlocked ? 'Blocked' : 'Active' %>
                                </span>
                            </td>

                            <td>
                                <label class="switch">
                                    <input type="checkbox" class="block-toggle" data-user-id="<%= user._id %>"
                                        <%=user.isBlocked ? '' : 'checked' %>
                                    >
                                    <span class="slider"></span>
                                </label>
                            </td>


                        </tr>
                        <% }) %>
                </tbody>
            </table>

            <!-- Pagination Footer -->
            <div class="pagination">

                <% if (currentPage> 1) { %>
                    <a href="?page=<%= currentPage - 1 %>" class="arrow">&lt;</a>
                    <% } %>

                        <% for (let i=1; i <=totalPages; i++) { %>
                            <a href="?page=<%= i %>" class="page <%= i === currentPage ? 'active' : '' %>">
                                <%= i %>
                            </a>
                            <% } %>

                                <% if (currentPage < totalPages) { %>
                                    <a href="?page=<%= currentPage + 1 %>" class="arrow">&gt;</a>
                                    <% } %>

            </div>


        </main>
        <script>
            document.querySelectorAll('.block-toggle').forEach(toggle => {
                toggle.addEventListener('change', async () => {
                    const userId = toggle.dataset.userId;
                    const previousState = toggle.checked;

                    try {
                        const res = await fetch(`/admin/users/${userId}/toggle-block`, {
                            method: 'PATCH',
                            headers: {
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin'
                        });


                        if (!res.ok) {
                            const data = await res.json().catch(() => ({}));
                            toggle.checked = !previousState;
                            alert(data.message || "Action failed");
                            return;
                        }

                        const data = await res.json();

                        if (!data.success) {
                            toggle.checked = !previousState;
                            alert(data.message || "Action failed");
                        }

                    } catch (err) {
                        toggle.checked = !previousState;
                        alert("Network error");
                    }
                });
            });





            function showToast(message, type = "info") {
                const container = document.getElementById("toast-container");
                if (!container) return;

                const toast = document.createElement("div");
                toast.className = `toast toast-${type}`;
                toast.textContent = message;

                container.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3300);
            }
        </script>