<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Styles</title>
</head>
<body>

  <%- include('../partials/toast') %>
  <%- include('../partials/admin/sidebar') %>

  <main class="main-content">
    <div class="admin-header">
      <div class="breadcrumb"><span class="fade">Admin</span> &gt; Styles</div>
    </div>

    <div class="container">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>S.No</th>
              <th>Style</th>
              <th>List / Unlist</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% if (styles && styles.length) { %>
              <% styles.forEach((s, idx) => { %>
                <tr data-id="<%= s._id %>">
                  <td class="col-index"><%= idx + 1 %></td>
                  <td class="col-name"><%= s.name %></td>
                  <td class="col-listed">
                    <label class="switch">
                      <input type="checkbox" <%= s.isListed ? 'checked' : '' %> onchange="handleToggle('<%= s._id %>')">
                      <span class="slider"></span>
                    </label>
                  </td>
                  <td class="col-actions">
                    <div class="action-btns">
                      <button class="btn-icon" onclick="openInlineEdit('<%= s._id %>')">üìù</button>
                      <button class="btn-icon btn-delete" onclick="deleteStyle('<%= s._id %>')">üóëÔ∏è</button>
                    </div>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr><td colspan="4">No styles found.</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <div class="add-card">
        <h2>Add New Style</h2>
        <form action="/admin/add-style" method="POST">
          <div class="form-flex">
            <div class="input-group">
              <label>Name:</label>
              <input type="text" name="styleName" required>
            </div>
            <div class="input-group">
              <label>List / Unlist :</label>
              <label class="switch">
                <input type="checkbox" name="isListed" checked>
                <span class="slider"></span>
              </label>
            </div>
          </div>
          <div class="save-container">
            <button type="submit" class="save-btn">SAVE</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // Reuse simple helpers similar to category page
    const getRow = (id) => document.querySelector(`tr[data-id="${id}"]`);
    const escapeHtml = (str = '') => String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');

    async function fetchJson(url, opts = {}) {
      opts.headers = { ...(opts.headers || {}), Accept: 'application/json' };
      const res = await fetch(url, opts);
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) throw new Error('Session expired or unexpected server response');
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Request failed');
      return data;
    }

    window.handleToggle = async (id) => {
      try {
        await fetchJson(`/admin/toggle-style/${id}`, { method: 'PATCH' });
        showToast('Style status updated', 'success');
        setTimeout(() => window.location.reload(), 600);
      } catch (err) {
        showToast(err.message || 'Failed to update style', 'error');
      }
    };

    window.deleteStyle = (id) => {
      if (confirm('Are you sure you want to delete this style?')) {
        window.location.href = `/admin/delete-style/${id}`;
      }
    };

    window.openInlineEdit = (id) => {
      const row = getRow(id);
      if (!row) return showToast('Row not found', 'error');
      if (row.querySelector('.inline-name')) return showToast('Already editing', 'warning');

      row.dataset.prev = row.innerHTML;
      const name = row.querySelector('.col-name').textContent.trim();
      const listed = !!row.querySelector('.col-listed input[type="checkbox"]')?.checked;

      row.querySelector('.col-name').innerHTML = `<input class="inline-name" value="${escapeHtml(name)}" style="padding:6px;border-radius:4px;border:1px solid #ddd;width:180px">`;
      row.querySelector('.col-listed').innerHTML = `<label class="switch"><input type="checkbox" class="inline-listed" ${listed ? 'checked' : ''}><span class="slider"></span></label>`;
      row.querySelector('.col-actions').innerHTML = `<div class="action-btns"><button class="btn-icon" onclick="saveInlineEdit('${id}')">üíæ</button><button class="btn-icon btn-delete" onclick="cancelInlineEdit('${id}')">‚úñ</button></div>`;
    };

    window.cancelInlineEdit = (id) => {
      const row = getRow(id);
      if (!row || !row.dataset.prev) return;
      row.innerHTML = row.dataset.prev;
      delete row.dataset.prev;
    };

    window.saveInlineEdit = async (id) => {
      const row = getRow(id);
      if (!row) return showToast('Row not found', 'error');

      const name = row.querySelector('.inline-name')?.value?.trim();
      const isListed = !!row.querySelector('.inline-listed')?.checked;
      if (!name) return showToast('Name is required', 'error');

      try {
        const data = await fetchJson(`/admin/style/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ styleName: name, isListed }) });
        const style = data.style || data;
        row.innerHTML = `
          <td class="col-index">${row.querySelector('.col-index')?.textContent || ''}</td>
          <td class="col-name">${escapeHtml(style.name)}</td>
          <td class="col-listed"><label class="switch"><input type="checkbox" ${style.isListed ? 'checked' : ''} onchange="handleToggle('${style._id}')"><span class="slider"></span></label></td>
          <td class="col-actions"><div class="action-btns"><button class="btn-icon" onclick="openInlineEdit('${style._id}')">üìù</button><button class="btn-icon btn-delete" onclick="deleteStyle('${style._id}')">üóëÔ∏è</button></div></td>
        `;
        showToast('Style updated', 'success');
      } catch (err) {
        showToast(err.message || 'Update failed', 'error');
      }
    };
  </script>
</body>
</html>